<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="MARTi: Metagenomic Analysis in Real Time">
  <meta name="author" content="Ned Peel">

  <title>MARTi</title>
  <link rel="icon" href="/images/favicon.svg">
  <!-- fonts -->
  <link href="/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
  <link href="/css/googleFontsNunito.css" rel="stylesheet">

  <!-- styles -->
  <link href="/css/sb-admin-2.css" rel="stylesheet">
  <link href="/css/index.css" rel="stylesheet">
  <link href="/css/compare.css" rel="stylesheet">
  <link href="/css/universal.css" rel="stylesheet">


<link href="/css/jquery.dataTables.min.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="/css/buttons.dataTables.min.css"/>


  <!-- D3 library -->
  <script src="/js/d3.v3.min.js" type="text/javascript"></script>

  <!-- Bootstrap core JavaScript-->
  <script src="/vendor/jquery/jquery.min.js"></script>
  <script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

  <!-- Core plugin JavaScript-->
  <script src="/vendor/jquery-easing/jquery.easing.min.js"></script>

  <!-- Sortable JavaScript-->
  <script src="/js/sortable.min.js" type="text/javascript"></script>



  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/FileSaver.js" type="text/javascript"></script>
<script src="/js/canvg_3.0.7.js"></script>


  <script src="/js/ResizeSensor.js" type="text/javascript"></script>

<script src="/js/universal.js" type="text/javascript"></script>
<script src="/js/export.js" type="text/javascript"></script>


<!-- Sample page -->
<link href="/css/samples.css" rel="stylesheet">
<script src="/js/samples.js" type="text/javascript"></script>

<!-- New analysis page -->
<link href="/css/new.css" rel="stylesheet">
<script src="/js/new.js" type="text/javascript"></script>

<!-- Dashboard page -->
<script src="/js/dashboard.js" type="text/javascript"></script>
<link href="/css/dashboard.css" rel="stylesheet">
<!-- Compare page -->
<script src="/js/compare.js" type="text/javascript"></script>

<!-- D3 plot scripts -->
<script src="/js/dashboardReadsDonut.js" type="text/javascript"></script>
<script src="/js/dashboardDonut.js" type="text/javascript"></script>
<link href="/css/dashboardTaxaDonut.css" rel="stylesheet">

<script src="/js/dashboardTree.js" type="text/javascript"></script>
<link href="/css/dashboardTree.css" rel="stylesheet">

<script src="/js/dashboardTreeMap.js" type="text/javascript"></script>
<link href="/css/dashboardTreeMap.css" rel="stylesheet">

<script src="/js/dashboardAmrDonut.js" type="text/javascript"></script>
<link href="/css/dashboardAmrDonut.css" rel="stylesheet">

<script src="/js/dashboardAmrHitsDonut.js" type="text/javascript"></script>
<!-- <link href="/css/dashboardAmrDonut.css" rel="stylesheet"> -->


<script src="/js/heatmapTaxa.js" type="text/javascript"></script>
<link href="/css/heatmapTaxa.css" rel="stylesheet">


<script src="/js/stackedBar.js" type="text/javascript"></script>
<link href="/css/stackedBar.css" rel="stylesheet">

<script src="/js/compareDonut.js" type="text/javascript"></script>
<link href="/css/compareDonut.css" rel="stylesheet">


<script src="/js/compareAmrHeatmap.js" type="text/javascript"></script>
<link href="/css/compareAmrHeatmap.css" rel="stylesheet">

<script src="/js/rarefactionCompare.js" type="text/javascript"></script>
<link href="/css/rarefactionCompare.css" rel="stylesheet">

<script src="/js/compareTree.js" type="text/javascript"></script>
<link href="/css/compareTree.css" rel="stylesheet">

<script src="/js/jquery.dataTables.min.js" type="text/javascript"></script>
<script src="/js/dataTables.bootstrap4.min.js" type="text/javascript"></script>


<script src="/js/dataTables.select.min.js" type="text/javascript"></script>
<script type="text/javascript" src="/js/dataTables.buttons.min.js"></script>
<script type="text/javascript" src="/js/buttons.html5.min.js"></script>

<link href="/vendor/leaflet/leaflet.css" rel="stylesheet">
<script src="/vendor/leaflet/leaflet.js" type="text/javascript"></script>

<link href="/vendor/leaflet/MarkerCluster.css" rel="stylesheet">
<link href="/vendor/leaflet/MarkerCluster.Default.css" rel="stylesheet">
<script src="/vendor/leaflet/leaflet.markercluster.js" type="text/javascript"></script>

<style type="text/css" media="screen">

</style>

</head>

<body id="page-top">



  <!-- Page Wrapper -->
  <div id="wrapper">

    <!-- Sidebar -->

    <ul class="navbar-nav sidebar sidebar-dark accordion fixed-left" id="accordionSidebar">

      <!-- Sidebar - Brand -->
      <a class="sidebar-brand d-flex align-items-center justify-content-center">
        <div class="pointer sidebar-brand-icon marti-logo" id="sidebar-brand">
        </div>
      </a>

      <!-- Divider -->
      <hr class="sidebar-divider my-0">

      <!-- Nav Items -->
    <div id="sidebar-placeholder">

      <li class="nav-item pointer" id="samples-item">
        <a class="nav-link">
          <i class="fas fa-fw fa-table"></i>
          <span>Samples</span></a>
      </li>

      <!-- Divider -->
      <li class="nav-item pointer" id="dashboard-item">
        <a class="nav-link">
          <i class="fas fa-fw fa-tachometer-alt"></i>
          <span>Dashboard</span></a>
      </li>

      <li class="nav-item pointer" id="compare-item">
        <a class="nav-link">
          <i class="fas fa-fw fa-chart-bar"></i>
          <span>Compare</span></a>
      </li>

      <li class="nav-item pointer" id="new-item">
        <a class="nav-link">
          <i class="fas fa-fw fa-folder-plus"></i>
          <span>New analysis</span></a>
      </li>

      <!-- Divider -->
      <hr class="sidebar-divider my-0">

      <li class="nav-item">
        <a class="nav-link" href="https://marti.readthedocs.io/" target="_blank">
          <i class="fas fa-fw fa-file"></i>
          <span>Documentation</span></a>
      </li>


    </div>



    </ul>

    <!-- End of Sidebar -->

    <!-- Content Wrapper -->
    <div id="content-wrapper" class="d-flex flex-column">

      <!-- Main Content -->
      <div id="content">

        <!-- Topbar -->
        <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow justify-content-between">

          <!-- Sidebar Toggle (Topbar) -->
          <button id="sidebarToggleTop" class="btn btn-link rounded-circle">
            <i class="fa fa-bars"></i>
          </button>

          <h1 id="pageTitle" class="h3 mb-0 w-100 text-center text-gray-800">MARTi</h1>



          <ul class="navbar-nav ml-auto">

            <!-- Nav Item - modal -->
            <li class="nav-item dropdown no-arrow mx-1">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="modal" data-target="#optionsModal">
                <i class="fas fa-cog fa-fw"></i>
              </a>
            </li>
          </ul>

          <!-- Nav Item - modal -->
          <!-- <li class="nav-item dropdown no-arrow mx-1">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="modal" data-target="#sampleModal">
              <i class="fas fa-file-import fa-fw"></i>
            </a>
          </li> -->

        <!-- Nav Item - Alerts -->
        <!-- <li class="nav-item dropdown no-arrow mx-1">
          <a class="nav-link dropdown-toggle navbar-height" href="#" id="alertsDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <i id="alertBellIcon" class="fas fa-bell fa-fw"></i>
          </a>


          <div class="dropdown-list dropdown-menu dropdown-menu-right shadow animated--grow-in" aria-labelledby="alertsDropdown">
            <h6 id="alertsDropdownHeader" class="dropdown-header">
              Alerts
            </h6>

            <a class="dropdown-item text-center small text-gray-500" href="#">Alerts menu</a>

          </div>
          </li> -->


        </nav>
        <!-- End of Topbar -->

        <noscript>
      		<style>
      			#no-js {
      				margin: 0 auto;
              width: 100%;
      				padding: 1.5rem 0;
      				background-color: #f6c23e;
      				color: #000;
      				text-align: center;
              top: 0;
              position: absolute;
      			}
            #accordionSidebar {
              opacity: 0;
            }
      		</style>
      		<h3 id="no-js">To use MARTi, please enable JavaScript in your browser.</h3>
      	</noscript>

        <!-- Begin Page Content -->
        <div id="response" class="container-fluid">
        </div>


      </div>
      <!-- End of Main Content -->


        <footer class="sticky-footer bg-white">
          <div class="container my-auto">


            <div id="cyverseLogo" class="my-auto d-none text-center">
              <a class="d-inline-block" href="https://cyverseuk.org/" target="_blank">
              <img src="/images/cyverse_long.png" alt="Powered by CyverseUK" height=45 class="mx-auto d-block">
              </a>
            </div>

            <div class="copyright text-center my-auto">
              <span id="currentGuiVersion">MARTi GUI v0.0.0</span>
              <span id="currentClientCount" style="color:white">0</span>
            </div>
          </div>
        </footer>


    </div>
    <!-- End of Content Wrapper -->

  </div>
  <!-- End of Page Wrapper -->



  <!-- Scroll to Top Button-->
  <a class="scroll-to-top rounded" href="#page-top">
    <i class="fas fa-angle-up"></i>
  </a>

  <!-- Options Modal -->
  <div class="modal" id="optionsModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Options</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">


        <div id="globalColourPaletteSelector" class="form-group row">
          <div class="col-sm-3 ">
            <label class="">Colour palette</label>
          </div>

          <div class="col-auto">
              <div class="form-check mb-3">
                <input class="form-check-input" type="radio" name="globalColourPalette" id="globalColourPalette1" value="tolColorBlindLight9">
                <label class="form-check-label" for="globalColourPalette1">
                  Small (colour blind friendly) (9 colours)
                </label>
              </div>
              <div class="form-check mb-3">
                <input class="form-check-input" type="radio" name="globalColourPalette" id="globalColourPalette2" value="default11" checked>
                <label class="form-check-label" for="globalColourPalette2">
                  Default (11 colours)
                </label>
              </div>
              <div class="form-check mb-3">
                <input class="form-check-input" type="radio" name="globalColourPalette" id="globalColourPalette3" value="colorgorical14">
                <label class="form-check-label" for="globalColourPalette3">
                  Medium (14 colours)
                </label>
              </div>


              <div class="form-check mb-3">
                <input class="form-check-input" type="radio" name="globalColourPalette" id="globalColourPalette4" value="tolRainbow21">
                <label class="form-check-label" for="globalColourPalette4">
                  Large (21 colours)
                </label>
              </div>
              <div class="form-check mb-3">
                <input class="form-check-input" type="radio" name="globalColourPalette" id="globalColourPalette5" value="large24">
                <label class="form-check-label" for="globalColourPalette5">
                  Large (24 colours)
                </label>
              </div>

          </div>

        </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
  </div>

  <!-- Dashboard Modal -->
  <div class="modal" id="dashboardModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">You need to select a sample!</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>In order to access Dashboard mode, you must select a sample from the Sample selector table by clicking on the <i class="fas fa-tachometer-alt"></i> icon next to the sample name.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
  </div>

  <!-- Compare Modal -->
  <div class="modal" id="compareModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">You need to select a sample!</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>In order to access Compare mode, you must select at least one sample from the Sample table by checkbox <i class="far fa-check-square"></i></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- New Analysis Modal -->
<div class="modal" id="newAnalysisModal" tabindex="-1" role="dialog">
<div class="modal-dialog modal-dialog-centered" role="document">
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title">Page locked</h5>
      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="modal-body">
      <p>Download and install MARTi to access the new analysis page.</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
    </div>
  </div>
</div>
</div>


<!-- Portrait Modal -->
<div class="modal" id="portraitModal" tabindex="-1" role="dialog">
<div class="modal-dialog modal-dialog-centered" role="document">
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title">Portrait detected!</h5>
      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="modal-body">
      <p>MARTi works best in landscape. Please rotate your device.</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
    </div>
  </div>
</div>
</div>


</body>



<!-- Custom scripts for all pages-->
<script src="/js/sb-admin-2.js"></script>


<script>



$(document).ready(function () {

  function detectOrientation(mediaQueryList) {
      if (mediaQueryList.matches) {
          console.log("Show portrait orientation warning");
          $('#portraitModal').modal('show');
      } else {
          console.log("Hide portrait orientation warning");
          $('#portraitModal').modal('hide');
      }
  }

  const mediaQuery = window.matchMedia("(orientation: portrait) and (max-width: 600px)");

  // Call the function initially
  detectOrientation(mediaQuery);

  // Listen for orientation changes
  mediaQuery.addListener(detectOrientation);

    $("h1#pageTitle").text("Samples");
    activeSidebarIcon($("#samples-item"));
    currentPage = "Samples";
    $("#response").load("/samples.html", function() {
      let checkId = function() {
        setTimeout(function () {
          if (uuid === null) {
            checkId();
          }
          else {
              initialiseSamplePage();
          }
        }, 50);
      };
      checkId();

    });

    $("#sidebar-brand").click(function () {
      if (currentPage !== "Samples"){
        activeSidebarIcon($("#samples-item"));
        currentPage = "Samples";
        $("h1#pageTitle").text("Samples");
        urlFormat();
        $("#response").load("/samples.html", function() {
        $("html, body").animate({ scrollTop: "0px" });
        initialiseSamplePage();
        });
      };
    });

    $("#samples-item").click(function () {
        activeSidebarIcon(this);
        currentPage = "Samples";
        $("h1#pageTitle").text("Samples");
        urlFormat();
        $("#response").load("/samples.html", function() {
        $("html, body").animate({ scrollTop: "0px" });
        initialiseSamplePage();
        });
    });

    $("#dashboard-item").click(function () {
      if (dashboardPageUnlocked == false) {
        $('#dashboardModal').modal('show')
      } else {
        activeSidebarIcon(this);
        currentPage = "Dashboard";
        $("h1#pageTitle").text("Dashboard");
        $("#response").load("/dashboard.html", function(){
          $("html, body").animate({ scrollTop: "0px" });
          initialiseDashboardPage();
        });
      };
    });

    $("#compare-item").click(function () {

      if (currentPage == "Samples"){
        emitSelectedCompareSamples();
      };

      if (comparePageUnlocked == false) {
        $('#compareModal').modal('show')
      } else {
        activeSidebarIcon(this);
        currentPage = "Compare";
        $("h1#pageTitle").text("Compare");
        urlFormat();
        $("#response").load("/compare.html", function(){
          $("html, body").animate({ scrollTop: "0px" });
          initialiseComparePage();
        });

        };
    });

    $("#new-item").click(function () {

      if (restrictedMode){
          $('#newAnalysisModal').modal('show')
      } else {
          activeSidebarIcon(this);
          currentPage = "New";
          $("h1#pageTitle").text("New analysis");
          urlFormat();
          $("#response").load("/new.html", function() {
          $("html, body").animate({ scrollTop: "0px" });
          initialiseNewPage();
          });
      }



    });

dashboardPageUnlocked = false;
comparePageUnlocked = false;



    socket.on('sampleLoadedAlert', function(sampleLoadedAlert) {
      sampleAddedAlert(sampleLoadedAlert.sampleName,sampleLoadedAlert.date,sampleLoadedAlert.icon);
    });

    function sampleAddedAlert(sampleName,date,icon){

    console.log(sampleName + " loaded alert");

      var newAlert = '<a class="dropdown-item d-flex align-items-center" href="#">\
        <div class="mr-3">\
          <div class="icon-circle bg-primary">\
            <i class="fas ' + icon + ' text-white"></i>\
          </div>\
        </div>\
        <div>\
          <div class="small text-gray-500">' + date + '</div>\
          <span class="font-weight-bold">' + sampleName + ' has been loaded successfully!</span>\
        </div>\
      </a>'

    $( "#alertsDropdownHeader" ).after( newAlert );

    $( "#alertBellIcon" ).after( '<span class="alertIconBadge badge badge-danger badge-counter">!</span>' );


    };

    $('#alertsDropdown').on( 'click', function () {
      $( ".alertIconBadge" ).remove();
    });

if (window.location.href.includes("marti.cyverseuk.org")) {
  $("#cyverseLogo").removeClass("d-none");
}



});

function activeSidebarIcon(icon) {
  $("#sidebar-placeholder .nav-item").removeClass("active");
  $(icon).addClass("active");
}

new ResizeSensor($('#accordionSidebar'), function(){
$('#content-wrapper').css("margin-left",$('#accordionSidebar').width());
});

$('#content-wrapper').css("margin-left",$('#accordionSidebar').width());


function createPaletteRects(palette) {

  var paletteOptions = d3.selectAll("#globalColourPaletteSelector .form-check")

  paletteOptions.append("div").attr("class", "paletteLegend");

  paletteOptions.each(function (){

    var paletteName = this.childNodes[1].value;

    var paletteRects = d3.select(this).select(".paletteLegend").selectAll(".paletteRect").data(colourPalettes[paletteName]);

    var paletteRectsEnter = paletteRects.enter().append("svg")
        .attr("height", 20)
        .attr("width", 20);

    paletteRectsEnter.append("rect")
        .attr("class", "paletteRect")
        .attr("height", 20)
        .attr("width", 20)
        .style("fill", function(d, i) { return d; });



  })


  }

  createPaletteRects();

$("input[name='globalColourPalette']").on("change", function(){

  selectedPalette = $(this).val();
  comparePlotColorPalette = d3.scale.ordinal()
      .range(colourPalettes[selectedPalette]);
  dashboardPlotColorPalette = d3.scale.ordinal()
      .range(colourPalettes[selectedPalette]);

  ctColor = d3.scale.ordinal()
      .range(colourPalettes[selectedPalette]);

dashboardColorIndex = colourPalettes[selectedPalette].length;

 if (currentPage == "Dashboard") {
   treeUpdate(root);
   treeMapUpdate(treeMapData);
   globUpdate(globDonutData);
   plotRarefactionCompare(rareData);
   if(dashboardChartVisibility["dashboardAmrTable"] == true){
     updateAmrTable(dashboardAmrReponseData);

   };
   if(dashboardChartVisibility["dashboardAmrDonut"] == true){
     plotAmrDonut(dashboardAmrReponseData);
   };

   if(dashboardChartVisibility["dashboardAmrHitsDonut"] == true){
     plotAmrHitsDonut(dashboardAmrReponseData);
   };




 } else if (currentPage == "Compare") {
   updateComparePlots(compareTreeDataGlobal);
   plotRarefactionCompare(rareData);
 }

});

$(window).on('online', updateOnlineStatus);
$(window).on('offline', updateOnlineStatus);

function updateOnlineStatus() {
    if (navigator.onLine) {
      $('#sampleMapPlotWarning').hide();
    } else {
      $('#sampleMapPlotWarning').show();
    }
}

</script>

</html>
